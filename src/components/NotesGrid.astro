---
import { getCollection } from "astro:content";
import { orderNotesByYear } from "../utils/orderNotesByYear.astro";
import type { Note, OrderedNotes } from "../types/types";

import "../styles/notes.css";

const { inPage } = Astro.props;

const allNotes = await getCollection("notes", ({ data }: { data: Note }) => {
  return data.isPublished === true;
});

const orderedNotes: OrderedNotes = orderNotesByYear(
  allNotes,
  inPage ? false : true
);
---

{
  // Page grid
  inPage ? (
    <div class="notes-grid">
      <h1 class="inPage regular">
        Todas las <span class="bold">notas</span>
      </h1>
      {Object.keys(orderedNotes)
        .sort((yearA, yearB) => (yearA < yearB ? 1 : -1))
        .map((year) => (
          <>
            <p class="title year">{year}</p>
            {Object.keys(orderedNotes[year])
              .sort((monthA, monthB) => (monthA < monthB ? 1 : -1))
              .map((month) => {
                const month_name = new Date(`1999/${month}/01`).toLocaleString(
                  "es-ES",
                  { month: "long" }
                );
                return (
                  <>
                    <p class="title month">{month_name}</p>
                    <div class="grid">
                      {orderedNotes[year][month]
                        .sort((noteA, noteB) => (noteA < noteB ? 1 : -1))
                        .map((note: Note) => {
                          const day = `${note.date.substring(8, 10)}`;
                          return (
                            <a class="item" href={`/notes/${note.slug}`}>
                              <p>{note.title}</p>
                              <hr />
                              <span>{day}</span>
                            </a>
                          );
                        })}
                    </div>
                  </>
                );
              })}
          </>
        ))}
    </div>
  ) : (
    // Index grid
    <div class="notes-grid">
      <h2 style="margin-bottom: var(--space-s)">Ãšltimas notas</h2>
      {Object.keys(orderedNotes)
        .sort((yearA, yearB) => (yearA < yearB ? 1 : -1))
        .map((year) => (
          <>
            {Object.keys(orderedNotes[year])
              .sort((monthA, monthB) => (monthA < monthB ? 1 : -1))
              .map((month) => (
                <div class="grid">
                  {orderedNotes[year][month]
                    .sort((noteA, noteB) => (noteA < noteB ? 1 : -1))
                    .map((note: Note) => {
                      const date = `${note.date.substring(8, 10)}/${note.date.substring(5, 7)}/${note.date.substring(2, 4)}`;
                      return (
                        <a class="item" href={`/notes/${note.slug}`}>
                          <p>{note.title}</p>
                          <hr />
                          <span>{date}</span>
                        </a>
                      );
                    })}
                </div>
              ))}
          </>
        ))}
      <a href="/notes" class="more">
        Ver todas las notas
      </a>
    </div>
  )
}
